/*
 * pn532.c
 *
 *  Created on: May 30, 2024
 *      Author: bogdsece
 */

#include "pn532.h"


#if ENABLE_I2C

extern I2C_HandleTypeDef hi2c1;

HAL_StatusTypeDef PN532_SendCommand(uint8_t* cmd, uint8_t cmd_len)
{
    return HAL_I2C_Master_Transmit(&hi2c1, PN532_I2C_ADDRESS << 1, cmd, cmd_len, HAL_MAX_DELAY);
}

HAL_StatusTypeDef PN532_ReadResponse(uint8_t* buffer, uint8_t buffer_len)
{
    return HAL_I2C_Master_Receive(&hi2c1, PN532_I2C_ADDRESS << 1, buffer, buffer_len, HAL_MAX_DELAY);
}

#endif //ENABLE_I2C


#if ENABLE_USART

extern UART_HandleTypeDef huart1; // Adjust this if you're using a different UART

	HAL_StatusTypeDef PN532_SendCommand(uint8_t* cmd, uint8_t cmd_len)
	{
		return HAL_UART_Transmit(&huart1, cmd, cmd_len, HAL_MAX_DELAY);
	}

	HAL_StatusTypeDef PN532_ReadResponse(uint8_t* buffer, uint8_t buffer_len)
	{
		return HAL_UART_Receive(&huart1, buffer, buffer_len, HAL_MAX_DELAY);
	}

#endif //ENABL_USART


void PN532_GetFirmwareVersion(void)
{
    uint8_t get_firmware_cmd[] = {
        0x00, 0x00, 0xFF, // Preamble and start code
        0x02, 0xFE, // Length and LCS
        0xD4, 0x02, // TFI and command code
        0x2A, // DCS
        0x00 // Postamble
    };

    if (PN532_SendCommand(get_firmware_cmd, sizeof(get_firmware_cmd)) != HAL_OK)
    {
    	printf("Error in PN532_SendCommand!\n");
        Error_Handler();
    }

    uint8_t response[20];
    HAL_StatusTypeDef PN532_fwRsp = PN532_ReadResponse(response, sizeof(response))
    if (PN532_fwRsp == HAL_OK)
    {
    	printf("PN532_fwRsp = %s\n",PN532_fwRsp);
    }
    else
    {
    	printf("Error in PN532_ReadResponse!\n");
        Error_Handler();
    }

    // Process the response to get firmware version
    // Print the response or check specific bytes in the response
    // You can use a debugger or printf to check the response
}
